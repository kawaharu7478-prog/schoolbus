<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>バス走行位置トラッカー</title>
<style>
  body {
    margin: 0;
    background: #fafafa;
    font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    overflow-y: scroll;
  }
  .tracker {
    position: relative;
    width: 100%;
    height: 100vh;
    background: #fff;
  }
  .clock {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    color: #f39c12;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  }
  .line {
    position: absolute;
    left: 50%;
    top: 0;
    transform: translateX(-50%);
    width: 20px;
    background: #f39c12;
    border-radius: 10px;
    z-index: 1;
  }
  .stop {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 10;
  }
  .stop .label {
    display: inline-block;
    background: #fff;
    border: 3px solid #f39c12;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .bus {
    position: absolute;
    width: 40px;
    height: 24px;
    border-radius: 12px;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: transform 0.5s linear;
    z-index: 5;
  }
  .bus.up { left: calc(50% - 70px); background: #e67e22; }
  .bus.down { left: calc(50% + 30px); background: #f1c40f; color: #333; }
</style>
</head>
<body>
  <div class="clock" id="clock">--:--:--</div>
  <div class="tracker" id="tracker">
    <div class="line" id="line"></div>
  </div>

<script>
const CSV_FILE = 'timetable.csv';
const tracker = document.getElementById('tracker');
const clockEl = document.getElementById('clock');
let stops = [];
let buses = [];

function parseCSV(text){
  return text.split(/\\r?\\n/).filter(l=>l.trim().length>0).map(l=>l.split(','));
}
function parseTime(v){
  if(!v) return null;
  if(v.includes(':')){
    const [h,m] = v.split(':').map(Number);
    return h*60+m;
  }
  const num = parseInt(v);
  const h = Math.floor(num/100);
  const m = num%100;
  return h*60+m;
}
function nowMin(){
  const d = new Date();
  return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
}
function formatTime(){
  const d = new Date();
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function lerp(a,b,t){return a+(b-a)*t;}

async function load(){
  const res = await fetch(CSV_FILE);
  const txt = await res.text();
  const rows = parseCSV(txt);
  const stopNames = rows[0].slice(3);
  buildStops(stopNames);

  buses = rows.slice(1).map(r=>{
    const direction = r[1];
    const id = r[2];
    const times = r.slice(3).map(parseTime);
    const el = document.createElement('div');
    el.className = `bus ${direction}`;
    el.textContent = id;
    tracker.appendChild(el);
    return {direction, id, times, el};
  });
}

function buildStops(names){
  const baseSpacing = 150; // 車庫〜五日市駅南口
  const longSpacing = baseSpacing * 3; // 五日市駅南口〜広島工大
  let y = 100;
  names.forEach((name,i)=>{
    const s = document.createElement('div');
    s.className = 'stop';
    s.innerHTML = `<div class="label">${name}</div>`;
    s.style.top = y + 'px';
    tracker.appendChild(s);
    stops.push({name, y});
    if(i === 0) y += baseSpacing;
    else if(i === 1) y += longSpacing;
  });
  tracker.style.height = (y + 300) + 'px';
  document.getElementById('line').style.height = (y + 300) + 'px';
}

function mapIndex(i, dir){
  return dir === 'up' ? stops.length - 1 - i : i;
}

function update(){
  const n = nowMin();
  clockEl.textContent = formatTime();

  buses.forEach(bus=>{
    const t = bus.times;
    let idx = -1;
    for(let i=0;i<t.length-1;i++){
      if(n >= t[i] && n <= t[i+1]){
        idx = i;
        break;
      }
    }
    let y;
    if(idx === -1){
      y = n < t[0] ? stops[mapIndex(0,bus.direction)].y
                   : stops[mapIndex(stops.length-1,bus.direction)].y;
    } else {
      const f = (n - t[idx]) / (t[idx+1] - t[idx]);
      const y0 = stops[mapIndex(idx,bus.direction)].y;
      const y1 = stops[mapIndex(idx+1,bus.direction)].y;
      y = lerp(y0, y1, f);
    }
    bus.el.style.transform = `translateY(${y - 12}px)`;
  });
}

(async()=>{
  await load();
  setTimeout(()=>{
    update();
    setInterval(update, 1000);
  },300);
})();
</script>
</body>
</html>
