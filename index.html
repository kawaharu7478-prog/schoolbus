<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>バス走行位置トラッカー</title>
  <style>
    body {
      font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #fafafa;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .tracker {
      position: relative;
      width: 500px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      padding: 40px 0;
    }

    /* 現在時刻表示 */
    .clock {
      position: absolute;
      top: 10px;
      left: 10px;
      font-weight: bold;
      font-size: 1.1rem;
      color: #f39c12;
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      z-index: 10;
    }

    /* 縦ライン（中央オレンジ） */
    .line {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      width: 16px;
      height: 100%;
      background: #f39c12;
      border-radius: 8px;
    }

    /* 停留所 */
    .stop {
      position: relative;
      width: 100%;
      height: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .stop .label {
      position: relative;
      z-index: 2;
      background: #fff;
      border: 3px solid #f39c12;
      color: #333;
      font-weight: bold;
      border-radius: 12px;
      padding: 10px 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* バスアイコン */
    .bus {
      position: absolute;
      width: 40px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .bus.up { left: calc(50% - 60px); background: #e67e22; }
    .bus.down { left: calc(50% + 20px); background: #f1c40f; color:#333; }

  </style>
</head>
<body>
  <div class="tracker" id="tracker">
    <div class="clock" id="clock">--:--:--</div>
    <div class="line"></div>
  </div>

  <script>
  const CSV_FILE = 'timetable.csv';
  const tracker = document.getElementById('tracker');
  const clockEl = document.getElementById('clock');
  let stops = [];
  let buses = [];

  function parseCSV(text){
    return text.split(/\r?\n/).filter(l=>l.trim().length>0).map(l=>l.split(','));
  }

  function parseTime(v){
    if(!v) return null;
    v = v.toString();
    if(v.includes(':')){
      const [h,m] = v.split(':').map(Number);
      return h*60+m;
    }
    const num = parseInt(v);
    const h = Math.floor(num/100);
    const m = num%100;
    return h*60+m;
  }

  function nowMin(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
  }

  function formatTime(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  function lerp(a,b,t){ return a+(b-a)*t; }

  async function load(){
    const res = await fetch(CSV_FILE);
    const txt = await res.text();
    const rows = parseCSV(txt);
    const header = rows[0];
    const stopNames = header.slice(3);
    buildStops(stopNames);

    buses = rows.slice(1).map((r,i)=>{
      const direction = r[1];
      const id = r[2];
      const times = r.slice(3).map(parseTime);
      const el = document.createElement('div');
      el.className = `bus ${direction}`;
      el.textContent = id;
      tracker.appendChild(el);
      return {direction, id, times, el};
    });
  }

  function buildStops(names){
    names.forEach(name=>{
      const s = document.createElement('div');
      s.className = 'stop';
      s.innerHTML = `<div class="label">${name}</div>`;
      tracker.appendChild(s);
      stops.push(s);
    });
    requestAnimationFrame(()=>{
      stops.forEach(st=>{
        const rect = st.getBoundingClientRect();
        const parentRect = tracker.getBoundingClientRect();
        st.y = rect.top - parentRect.top + rect.height/2;
      });
    });
  }

  function mapIndex(i, dir){
    return dir==='up' ? stops.length-1-i : i;
  }

  function update(){
    const n = nowMin();
    clockEl.textContent = formatTime(); // 現在時刻を更新

    buses.forEach(bus=>{
      const t = bus.times;
      let idx=-1;
      for(let i=0;i<t.length-1;i++){
        if(n>=t[i] && n<=t[i+1]){idx=i;break;}
      }
      let y;
      if(idx===-1){
        y = n<t[0]?stops[mapIndex(0,bus.direction)].y:stops[mapIndex(stops.length-1,bus.direction)].y;
      } else {
        const f = (n-t[idx])/(t[idx+1]-t[idx]);
        const y0 = stops[mapIndex(idx,bus.direction)].y;
        const y1 = stops[mapIndex(idx+1,bus.direction)].y;
        y = lerp(y0,y1,f);
      }
      bus.el.style.transform = `translateY(${y-12}px)`;
    });
  }

  (async()=>{
    await load();
    setTimeout(()=>{
      update();
      setInterval(update,1000);
    },300);
  })();
  </script>
</body>
</html>
