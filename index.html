<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>バス走行位置表示</title>
  <style>
    body {
      margin: 0;
      background: #ffffff;
      font-family: sans-serif;
      overflow: hidden;
    }

    #currentTime {
      position: fixed;
      top: 10px;
      left: 20px;
      font-size: 20px;
      color: #333;
      z-index: 10;
    }

    .map {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* ▼ オレンジラインを太くする（4px → 8px） */
    .center-line {
      position: relative;
      width: 16px;
      height: 90vh;
      background-color: orange;
      border-radius: 4px;
    }

    .stop {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      background: white;
      padding: 3px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .bus {
      position: absolute;
      width: 80px;
      transition: top 1s linear;
    }

    /* ▼ バスの左右位置を広げてラインから少し離す */
    .left {
      left: calc(50% - 130px); /* 以前より30px離す */
    }

    .right {
      left: calc(50% + 90px);  /* 以前より30px離す */
    }
  </style>
</head>
<body>
  <div id="currentTime"></div>
  <div class="map">
    <div class="center-line" id="line"></div>
    <div class="stop" id="koudai" style="top:10%;">広島工大</div>
    <div class="stop" id="itsukaichi" style="top:55%;">五日市駅南口</div>
    <div class="stop" id="depot" style="top:80%;">車庫</div>
  </div>

  <script>
    function updateClock() {
      const now = new Date();
      document.getElementById("currentTime").textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function loadCSV() {
      const response = await fetch(`timetable.csv?v=${Date.now()}`, { cache: "no-store" });
      const text = await response.text();
      return text.trim();
    }

    function getBusIcon(type) {
      const timestamp = Date.now();
      if (type === "1") return `2995.png?v=${timestamp}`;
      if (type === "2") return `2694.png?v=${timestamp}`;
      return "";
    }

    function parseCSV(csv) {
      const lines = csv.split("\n");
      const header = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        header.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : "");
        return obj;
      });
    }

    function timeToMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function interpolate(pos1, pos2, t1, t2, now) {
      if (t1 === null || t2 === null) return null;
      const minT = Math.min(t1, t2);
      const maxT = Math.max(t1, t2);
      if (now < minT || now > maxT) return null;
      const ratio = (now - t1) / (t2 - t1);
      return pos1 + (pos2 - pos1) * ratio;
    }

    function drawBus(busData, nowMinutes) {
      const line = document.getElementById("line");
      const lineHeight = line.clientHeight;
      const stops = {
        "広島工大": line.offsetTop + 0.1 * lineHeight,
        "五日市駅南口": line.offsetTop + 0.55 * lineHeight,
        "車庫": line.offsetTop + 0.80 * lineHeight
      };

      busData.forEach((bus, idx) => {
        const bustype = bus.bustype;
        const dir = bus.direction;
        const startStop = dir === "up" ? "車庫" : "広島工大";
        const midStop = "五日市駅南口";
        const endStop = dir === "up" ? "広島工大" : "車庫";

        const times = [
          { stop: startStop, time: timeToMinutes(bus[startStop]) },
          { stop: midStop, time: timeToMinutes(bus[midStop]) },
          { stop: endStop, time: timeToMinutes(bus[endStop]) }
        ].filter(x => x.time !== null);

        if (times.length < 2) return;

        let posY = null;
        for (let i = 0; i < times.length - 1; i++) {
          const t1 = times[i], t2 = times[i + 1];
          posY = interpolate(stops[t1.stop], stops[t2.stop], t1.time, t2.time, nowMinutes);
          if (posY !== null) break;
        }

        const existing = document.getElementById(`bus-${idx}`);
        if (!posY) {
          if (existing) existing.style.display = "none";
          return;
        }

        let busEl = existing;
        if (!busEl) {
          busEl = document.createElement("img");
          busEl.id = `bus-${idx}`;
          busEl.src = getBusIcon(bustype);
          busEl.alt = "バス";
          busEl.className = `bus ${dir === "up" ? "left" : "right"}`;
          document.body.appendChild(busEl);
        }

        busEl.style.display = "block";
        busEl.style.top = `${posY}px`;
      });
    }

    async function main() {
      const csvText = await loadCSV();
      const busData = parseCSV(csvText);

      function tick() {
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
        drawBus(busData, nowMinutes);
      }

      tick();
      setInterval(tick, 1000);
    }

    main();
  </script>
</body>
</html>


