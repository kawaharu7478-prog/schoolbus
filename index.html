<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>バス走行位置表示</title>
  <style>
    body {
      margin: 0;
      background: #ffffff;
      font-family: sans-serif;
      overflow: hidden;
    }

    #currentTime {
      position: fixed;
      top: 10px;
      left: 20px;
      font-size: 20px;
      color: #333;
      z-index: 10;
    }

    .map {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .center-line {
      position: relative;
      width: 4px;
      height: 90vh;
      background-color: orange;
    }

    .stop {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      background: white;
      padding: 3px 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .bus {
      position: absolute;
      width: 40px;
      transition: top 1s linear;
    }

    .left {
      left: calc(50% - 70px);
    }

    .right {
      left: calc(50% + 30px);
    }
  </style>
</head>
<body>
  <div id="currentTime"></div>
  <div class="map">
    <div class="center-line" id="line"></div>
    <div class="stop" id="koudai" style="top:10%;">広島工大</div>
    <div class="stop" id="itsukaichi" style="top:55%;">五日市駅南口</div>
    <div class="stop" id="depot" style="top:80%;">車庫</div>
  </div>

  <script>
    // 現在時刻表示
    function updateClock() {
      const now = new Date();
      document.getElementById("currentTime").textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    // CSV読み込み
    async function loadCSV() {
      const response = await fetch(`timetable.csv?v=${Date.now()}`, { cache: "no-store" });
      const text = await response.text();
      return text.trim();
    }

    // バス画像切替
    function getBusIcon(type) {
      const timestamp = Date.now();
      if (type === "1") return `2995.png?v=${timestamp}`;
      if (type === "2") return `2694.png?v=${timestamp}`;
      return "";
    }

    // CSVパース
    function parseCSV(csv) {
      const lines = csv.split("\n");
      const header = lines[0].split(",");
      const data = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        header.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : "");
        return obj;
      });
      return data;
    }

    // "7:15" → 分単位
    function timeToMinutes(t) {
      if (!t) return null;
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    // 線形補完（時刻の昇順・降順どちらでも動作）
    function interpolate(pos1, pos2, t1, t2, now) {
      if (t1 === null || t2 === null) return null;
      if (t1 === t2) return pos2;
      // 昇順 or 降順どちらでも対応
      const minT = Math.min(t1, t2);
      const maxT = Math.max(t1, t2);
      if (now < minT || now > maxT) return null;
      const ratio = (now - t1) / (t2 - t1);
      return pos1 + (pos2 - pos1) * ratio;
    }

    // バス描画
    function drawBus(busData, nowMinutes) {
      const line = document.getElementById("line");
      const lineHeight = line.clientHeight;
      const stops = {
        "広島工大": line.offsetTop + 0.1 * lineHeight,
        "五日市駅南口": line.offsetTop + 0.55 * lineHeight,
        "車庫": line.offsetTop + 0.80 * lineHeight
      };

      busData.forEach((bus, idx) => {
        const bustype = bus.bustype;
        const dir = bus.direction;
        const startStop = dir === "up" ? "車庫" : "広島工大";
        const midStop = "五日市駅南口";
        const endStop = dir === "up" ? "広島工大" : "車庫";

        const tStart = timeToMinutes(bus[startStop]);
        const tMid = timeToMinutes(bus[midStop]);
        const tEnd = timeToMinutes(bus[endStop]);

        let posY = null;

        // ====== 修正版ロジック ======
        if (tStart && tMid && nowMinutes >= Math.min(tStart, tMid) && nowMinutes <= Math.max(tStart, tMid)) {
          posY = interpolate(stops[startStop], stops[midStop], tStart, tMid, nowMinutes);
        } else if (tMid && tEnd && nowMinutes >= Math.min(tMid, tEnd) && nowMinutes <= Math.max(tMid, tEnd)) {
          posY = interpolate(stops[midStop], stops[endStop], tMid, tEnd, nowMinutes);
        }

        const existing = document.getElementById(`bus-${idx}`);
        if (!posY) {
          if (existing) existing.style.display = "none";
          return;
        }

        // 出発前・終点後は非表示
        const minT = Math.min(tStart || Infinity, tEnd || -Infinity);
        const maxT = Math.max(tStart || -Infinity, tEnd || Infinity);
        if (nowMinutes < minT || nowMinutes > maxT) {
          if (existing) existing.style.display = "none";
          return;
        }

        let busEl = existing;
        if (!busEl) {
          busEl = document.createElement("img");
          busEl.id = `bus-${idx}`;
          busEl.src = getBusIcon(bustype);
          busEl.alt = "バス";
          busEl.className = `bus ${dir === "up" ? "left" : "right"}`;
          document.body.appendChild(busEl);
        }

        busEl.style.display = "block";
        busEl.style.top = `${posY}px`;
      });
    }

    // メインループ
    async function main() {
      const csvText = await loadCSV();
      const busData = parseCSV(csvText);

      function tick() {
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
        drawBus(busData, nowMinutes);
      }

      tick();
      setInterval(tick, 1000);
    }

    main();
  </script>
</body>
</html>
